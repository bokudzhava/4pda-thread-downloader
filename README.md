# 4PDA Thread Downloader

Пользовательский скрипт (UserScript) для [Tampermonkey](https://www.tampermonkey.net/)  , предназначенный для автоматического скачивания и архивации веток форума **4PDA** в читаемый текстовый файл (`.txt`).

Скрипт умеет скачивать как всю ветку целиком, так и выбранный диапазон страниц, сохраняя структуру диалогов и форматирование.

## Возможности

*   **Скачивание диапазона:** Выбор начальной и конечной страницы. Скрипт сам определяет последнее сообщение в теме.
*   **Умное форматирование:**
    *   Преобразование HTML-цитат в текстовый вид с «ёлочками» (`«Цитата»`).
    *   Замена ссылок-стрелочек (ответ на сообщение) на локальный номер поста (например, `>> #5`).
    *   Сохранение URL ссылок внутри текста: `Текст ссылки [ https://... ]`.
*   **Нумерация постов:** Добавляет локальный номер сообщения (например, `#1`, `#250`) в заголовок блока, даже если форум использует глобальные ID.
*   **Очистка мусора:** Удаляет подписи, информацию о редактировании, технические данные изображений и лишние пробелы.
*   **Удаление дублей:** Автоматически пропускает закрепленные посты («шапки») на последующих страницах.
*   **Компактный интерфейс:** Удобная панель настроек в стиле сайта (поддерживает тёмную тему).
*   **Защита от бана:** Настраиваемая задержка между запросами для обхода защиты 4PDA (Cloudflare/Captcha).

## Установка

Требования: [Tampermonkey](https://www.tampermonkey.net/) (расширение для браузера)  
Установка: [4pda-thread-downloader.user.js](https://github.com/bokudzhava/4pda-thread-downloader/raw/refs/heads/main/4pda-thread-downloader-1.0.user.js)

## Использование

1.  Зайдите на любую ветку форума **4pda.to** (или **4pda.ru**).
    > **Важно:** Вы должны быть авторизованы на форуме, чтобы видеть контент и изображения (скрипт использует ваши текущие куки).
2.  В правом нижнем углу появится круглая кнопка со стрелкой **⇓**.
3.  Нажмите на неё, чтобы открыть панель настроек.
4.  Укажите:
    *   **С стр:** Номер первой страницы для скачивания.
    *   **По стр:** Номер последней страницы (определяется автоматически, но можно изменить).
    *   **Пауза:** Задержка в миллисекундах (рекомендуется **не менее 1000мс**, по умолчанию 1200мс).
5.  Нажмите кнопку **СКАЧАТЬ**.
6.  Дождитесь окончания процесса (прогресс отображается на панели).
7.  Браузер предложит сохранить файл `THREAD_Название_темы.txt`.

## Пример формата выходного файла

```text
Время: 12.11.24, 11:09
Автор: UserName
Номер: #2
Сообщение:
Всем привет! У кого есть проблемы с Wi-Fi на новой прошивке?

--------------------------------------------------------------------------------

Время: 12.11.24, 14:21
Автор: Helper2000
Номер: #3
Сообщение:
>> #2 UserName,

UserName @ 12.11.24, 11:09 [ #2 ]
«У кого есть проблемы с Wi-Fi на новой прошивке?»

Попробуй сбросить настройки сети. Инструкция здесь [ https://4pda.to/... ]
```

## Важная информация
*   **Кодировка:** Скрипт автоматически декодирует страницы из `windows-1251`.
*   **Скорость:** Не устанавливайте задержку (Паузу) слишком маленькой (менее 500-800 мс). 4PDA имеет агрессивную защиту от парсинга. Если вы будете делать запросы слишком часто, сервер временно заблокирует доступ или выдаст капчу, и скачивание прервется с ошибкой.
*   **Ошибки:** Если в файле вы видите `!!! ОШИБКА ЗАГРУЗКИ СТРАНИЦЫ !!!`, откройте консоль браузера (`F12`), чтобы узнать детали (обычно это ошибка 403 или 503 из-за частых запросов).
